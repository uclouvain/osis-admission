{% load enums i18n bootstrap3 admission %}

{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2026 Universit√© catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}

{% if object_list %}
  <div class="flex-content">
    <p>
      {% blocktrans with start_index=page_obj.start_index end_index=page_obj.end_index count total_counts=paginator.count trimmed %}
        One enrolment application
      {% plural %}
        {{ start_index }} to {{ end_index }} of {{ total_counts }} enrolment applications
      {% endblocktrans %}
    </p>
    <div>
      <button type="button" class="btn btn-default"
              data-toggle="modal" data-target="#modalColumnSelection">
        <i class="fa-solid fa-table-list"></i>
        {% trans "Columns" %}
      </button>
    </div>
    <div id="list-actions" class="text-right">
      {% bootstrap_field filter_form.taille_page show_label=False form_group_class="fit-content" show_help=False %}
      <span>{% trans "items per page" %}</span>
      <div class="btn-group">
        <button
            id="dLabel"
            class="btn btn-default visible-lg-inline-block"
            type="button"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
            title="{% trans 'Export' %}"
        >
          <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
          {% block exports_list %}
          {% endblock %}
        </ul>
      </div>
    </div>
  </div>
  <table
      id="admission_result_list"
      class="table table-striped table-hover table-responsive"
  >
    <thead>
      <tr
          hx-boost="true"
          hx-indicator="#htmx-overlay"
          hx-target="#table_doctorate_admission"
      >
        {% block list_block_header %}
        {% endblock %}
      </tr>
    </thead>
    <tbody>
      {% for admission in object_list %}
        <tr>
          {% block list_block_row_result %}
          {% endblock %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <div
      class="text-center"
      hx-boost="true"
      hx-indicator="#htmx-overlay"
      hx-target="#table_doctorate_admission"
  >
    {% bootstrap_pagination page_obj extra=view.query_params.urlencode %}
  </div>
  {% block list_extra_script %}{% endblock %}
{% elif filter_form.is_bound %}
  <p>{% trans 'No enrolment application' %}</p>
{% endif %}

{# Modal columns selection #}
<div id="modalColumnSelection" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">{% trans "Columns selection" %}</h4>
      </div>
      <div class="modal-body">
        <form id="select-columns-form">
          <div class="list-group"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close'%} </button>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    {# Columns selection #}
    // We might have two element during an HTMX request
    const $headers = $('table#admission_result_list').first().find('thead tr th');
    const columnsStorageKey = `VisibleColumns_${window.location.pathname}`;
    const savedState = localStorage.getItem(columnsStorageKey);
    let visibleColumns;
    if (savedState) {
      visibleColumns = JSON.parse(savedState);
    } else {
      visibleColumns = $headers.toArray().map(e => e.textContent.trim());
    }

    const setColumnsVisibility = () => {
      $headers.each((index, element) => {
        const columnName = element.textContent.trim();
        if (visibleColumns.includes(columnName)) {
          $(element).show();
          $(`table#admission_result_list tr td:nth-child(${index + 1})`).show();
        } else {
          $(element).hide();
          $(`table#admission_result_list tr td:nth-child(${index + 1})`).hide();
        }
      });
    };
    setColumnsVisibility();

    const $selectColumnsFormDiv = $('#select-columns-form > div');

    $headers.each((index, element) => {
      const columnName = element.textContent.trim();

      const $label = $('<label class="list-group-item"></label>');
      const $input = $('<input type="checkbox">').attr('value', columnName);
      if (visibleColumns.includes(columnName)) {
        $input.prop('checked', true);
      }
      if (index === 0) {
        $label.prop('disabled', true);
        $input.prop('disabled', true);
      } else {
        $input.change(() => {
          if ($input.prop('checked') === true) {
            visibleColumns.push(columnName);
          } else {
            visibleColumns.splice(visibleColumns.indexOf(columnName), 1);
          }
          setColumnsVisibility();
          localStorage.setItem(columnsStorageKey, JSON.stringify(visibleColumns));
        });
      }

      $label.append($input);
      $label.append(' ' + columnName);
      $selectColumnsFormDiv.append($label);
    });
  })();
</script>
