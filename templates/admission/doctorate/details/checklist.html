{% extends base_template %}
{% load admission strings static %}

{% comment "License" %}
  * OSIS stands for Open Student Information System. It's an application
  * designed to manage the core business of higher education institutions,
  * such as universities, faculties, institutes and professional schools.
  * The core business involves the administration of students, teachers,
  * courses, programs and so on.
  *
  * Copyright (C) 2015-2024 Universit√© catholique de Louvain (http://www.uclouvain.be)
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation, either version 3 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * A copy of this license - GNU General Public License - is available
  * at the root of the source code of this program.  If not,
  * see http://www.gnu.org/licenses/.
{% endcomment %}

{% block actions %}{% endblock %}

{% block tab_content %}
  <div
      id="three-pane-checklist"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
      hx-push-url="false"
  >
    {% include "admission/doctorate/details/checklist_menu.html" %}

    {% url base_namespace|add:":checklist" view.kwargs.uuid as checklist_url %}
    {% concat '?next=' checklist_url '&next_hash_url=' as next_base_url %}

    <div
        id="tabs-content"
        class="tab-content"
    >
      <div role="tabpanel" class="tab-pane" id="send-email">
        {% include "admission/doctorate/includes/checklist/send_mail.html" %}
        <div class="info-part"></div>
      </div>
    </div>
    
    <div id="info-viewer-tab" class="viewer-tab">
      <div class="split-tab-slider"></div>
      <div class="info-content"></div>
    </div>
  
  </div>

{% endblock %}



{% block script %}
  {{ block.super }}
  <script type="text/javascript" src="{% static 'osis_document/osis-document-editor.umd.min.js' %}"></script>
  <script src="{% static 'admission/ckeditor.js' %}"></script>
    <script>
      // Prevent to save the DOM in cache when using htmx requests
      htmx.config.refreshOnHistoryMiss = true;
      htmx.config.historyCacheSize = 0;

      (function ($) {
          const defaultTab = window.location.hash || '#send-email';
          const checklistMenu = $('#checklist-menu');

          $('#toggle-menu-button').on('click', function(){
              checklistMenu.toggle();
              if (checklistMenu.is(':visible')) {
                $(this).addClass('active');
                $(this).prop('title', "{{ _('Hide the checklist menu') }}");
              } else {
                $(this).removeClass('active');
                $(this).prop('title', "{{ _('Show the checklist menu') }}");
              }
          });

          function autogrow () {
              if (this.scrollHeight > this.clientHeight) {
                  this.style.height = `${this.scrollHeight}px`;
              }
          }

          $('#tabs-content').on('input', 'textarea[name$="-comment"]', function () {
              autogrow.call(this);
          });

          const menuItems = $('#checklist-menu *[data-toggle="tab"]');

          menuItems.on('show.bs.tab', function (e) {
              {# Don't indicate the previous tab as selected #}
              $('#checklist-menu .active').removeClass('active');
              {# Hide all sub-items except the selected one #}
              const parentOfSelectedElement = $(this).parent()[0];
              $('#checklist-menu .sub-items').each(function(event){
                  if ($(this)[0] !== parentOfSelectedElement) {
                      $(this).hide();
                  }
              })
          });

          menuItems.on('shown.bs.tab', function (e) {
              $(this).parents('.list-group-item').find('.sub-items').show();

              const tabPaneId = $(this).attr('href');
              window.location.hash = tabPaneId;

              // refresh comment height
              autogrow.call($(tabPaneId).find('textarea[name$="-comment"]')[0]);

              // refresh info viewer (e.target = active && e.relatedTarget = previous)
              if (configurationCache.getItem('side-tab', 'documents') === 'info') {
                  const $info = $('#info-viewer-tab .info-content');
                  // move old info from info viewer to old tab
                  const oldTabPanel = $($(e.relatedTarget).parent().attr('href')).find('.info-part');
                  $info.children().detach().appendTo(oldTabPanel);
                  // move new info from current tab to info viewer
                  const currentTabPanel = $(tabPaneId).find('.info-part');
                  currentTabPanel.children().detach().appendTo($info);
              }
          });

          // Activate a specific tab from link click inside the checklist
          $('a[data-toggle="checklist-tab"]').on('click', function () {
              $(`#checklist-menu li[href="${$(this).attr('href')}"] a`).click();
          });

          $('#checklist-menu div[data-toggle="tab"]').on('click', function (event) {
              // When selecting a tab that have children,
              const parent = $(this).parent();
              parent.removeClass('active');
              parent.find('.sub-item').show('active');
          });

          let configurationCache = null;

          const sidebars = $('#document-viewer-tab, #info-viewer-tab');

          $(document).ready(function () {
              configurationCache = new BaseCache('admission_checklist_configuration');
              sidebars.css('min-width', configurationCache.getItem('split_size', '20%'));

              // Activate tab from hash on first load
              $(`#checklist-menu *[data-toggle="tab"][href="${defaultTab}"]`).click();

              if (configurationCache.getItem('side-tab', 'documents') === 'info') {
                  $('#infos-shortcut').click();
              } else {
                  $('#info-viewer-tab').hide();
              }

              $('textarea[name="comment"]:visible').each(autogrow);
          });

          let bound = false;
          $('.split-tab-slider').mousedown(function (e) {
              bound = true;
              e.preventDefault();
              const initialWidth = sidebars.outerWidth();
              const initialX = e.pageX;
              $(document).mousemove(function (e) {
                  e.preventDefault();
                  sidebars.css('min-width', initialWidth + (initialX - e.pageX));
              });
          });

          {# The document viewer is resizable so we apply the previous custom height if there is one #}
          $(document).on('htmx:afterSettle', '#document-details', function(){
              const documentEditorContainer = $('#document-editor-container');
              documentEditorContainer.css(
                  'height',
                  documentEditorContainer.find('#no-document-container').length === 0 ?
                    configurationCache.getItem('document_size', '100%')
                    : 'fit-content',
              );
          });

          $(document).mouseup(function (event) {
              if (bound) {
                  bound = false;
                  $(document).off('mousemove');
                  configurationCache.setItem('split_size', sidebars.css('min-width'));
                  $('.osis-document-editor .editor-container').each(function () {
                      this.dispatchEvent(new CustomEvent('setScale', { detail: 'auto' }));
                  });
              } else if (event.target.id === 'document-editor-container') {
                  {# The document viewer is resizable so we keep its height for future document reloads #}
                  configurationCache.setItem('document_size', $('#document-editor-container').css('height'));
              }
          });

          // Pass the ckeditor data to the form data if necessary
          $(document).on('click', '.ckeditor-form [type="submit"]', function(event) {
            $(this).closest('form').find("textarea[data-type=ckeditortype]").each(function() {
              CKEDITOR.instances[$(this).attr('id')].updateElement();
            })
          });

      })(jQuery);
  </script>
{% endblock script %}


{% block style %}
  {{ block.super }}
  <style>
    #three-pane-checklist {
      display: flex;
      position: relative;
    }

    #tabs-content, #info-viewer-tab, #document-viewer-tab {
      overflow-y: auto;
      overflow-x: auto;
    }

    #shortcuts {
      position: absolute;
      top: -60px;
      right: 0;
    }

    #checklist-menu {
      min-width: 200px;
      margin-right: 1em;
    }

    #checklist-menu li {
      cursor: pointer;
    }
    #checklist-menu li a {
      color: inherit;
    }
    #checklist-menu li a:hover {
      text-decoration: none;
    }

    #checklist-menu li.active {
      cursor: pointer;
      background: inherit;
      color: inherit;
    }

    #checklist-menu li.active > div > a, #checklist-menu li.active > a {
      font-weight: bold;
    }

    .viewer-tab {
      position: relative;
      padding: 0 15px;
      flex: 0;
      min-width: 50%;
    }

    .split-tab-slider {
      border: solid 1px #ddd;
      border-top: none;
      border-bottom: none;
      width: 3px;
      left: -1px;
      height: 100%;
      cursor: col-resize;
      position: absolute;
    }

    dl dt a.btn, .panel-heading .btn, .tab-edit-button {
      padding: 2px 5px 2px 7px;
      vertical-align: bottom;
    }

    dl dt a.btn, .tab-edit-button {
      margin-left: 0.5em;
    }

    .panel-heading .btn {
      margin-right: -0.5em;
      margin-top: -0.5em;
    }

    #toggle-menu-button {
      margin-right: 5px;
    }

    #tabs-content {
      padding: 0;
      flex: 1;
      overflow: auto;
      margin-right: 1em;
    }

    #tabs-content textarea {
      overflow: hidden;
    }

    #tabs-content .saving {
      position: relative;
    }

    #tabs-content .saving::after {
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(238, 238, 238, .5);
      content: "";
      top: 0;
    }

    #tabs-content .saving::before {
      position: absolute;
      left: 50%;
      top: 50%;
      font-size: 2em;
      margin-top: -1em;
      content: "\f110";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      -webkit-animation-name: fa-spin;
      animation-name: fa-spin;
      -webkit-animation-direction: normal;
      animation-direction: normal;
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
      -webkit-animation-iteration-count: infinite;
      animation-iteration-count: infinite;
      -webkit-animation-timing-function: steps(8);
      animation-timing-function: steps(8);
    }

    #tabs-content a.saving::before {
      left: -1.5em;
      top: 0;
      margin-top: 0;
      font-size: 1.5em;
    }

    #tabs-content a.saving::after {
      left: 0;
    }

    .modal .media-right a:first-child {
      display: none;
    }

    .checklist-state-button {
      transition-duration: 0.5s;
    }

    input:invalid {
      color: #a94442 !important;
    }

    #checklist-menu i {
      width: 1em;
      display: inline-block;
      margin-right: 5px;
    }

    #checklist-menu i:nth-child(2) {
      margin: 0 0 0 5px
    }

    #checklist-menu .sub-items {
      margin-top: 1em;
      margin-bottom: 0;
      max-width: 300px;
    }

    #checklist-menu .sub-item.bg-info {
      background-color: #d9edf7;
    }

    #checklist-menu .sub-item.bg-warning {
      background-color: #fcf8e3;
    }

    /* Allow to scroll the content above the header menu */
    html {
      overflow: auto;
      scroll-padding-top: 60px; /* height of sticky header */
    }

    #tabs-content #fiche_etudiant {
      overflow-x: hidden;
    }

  </style>
{% endblock style %}
