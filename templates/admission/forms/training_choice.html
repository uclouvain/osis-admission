{% extends base_template %}
{% load bootstrap3 i18n static admission %}

{% comment "License" %}
  * OSIS stands for Open Student Information System. It's an application
  * designed to manage the core business of higher education institutions,
  * such as universities, faculties, institutes and professional schools.
  * The core business involves the administration of students, teachers,
  * courses, programs and so on.
  *
  * Copyright (C) 2015-2024 Universit√© catholique de Louvain (http://www.uclouvain.be)
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation, either version 3 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * A copy of this license - GNU General Public License - is available
  * at the root of the source code of this program.  If not,
  * see http://www.gnu.org/licenses/.
{% endcomment %}

{% block form %}
  {% bootstrap_form_errors form %}

  {% panel _('Choose your course') %}

    <div class="row">
      <div class="col-md-6 required_field">
        {% bootstrap_field form.training_type %}
      </div>
      <div class="col-md-6">
        {% bootstrap_field form.campus %}
      </div>
    </div>

    <div id="training-container">
      {% if view.is_general %}
        <div id="general-education-training-container" class="required_field">
          {% bootstrap_field form.general_education_training %}
        </div>
      {% elif view.is_continuing %}
        <div id="continuing-education-training-container" class="required_field row">
          <div class="col-md-2">
            {% bootstrap_field form.academic_year %}
          </div>
          <div class="col-md-10">
            {% bootstrap_field form.continuing_education_training %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endpanel %}

  {% if view.is_general and admission.formation.type|admission_training_type == 'MASTER' %}
    {% translate 'Specific profile' context 'admission' as specific_profile_title %}
    {% panel specific_profile_title id="student-profile" %}
      <div class="required_field">
        {% bootstrap_field_with_tooltip form.has_double_degree_scholarship %}
        <div id="double-degree-scholarship-field">
          {% bootstrap_field form.double_degree_scholarship show_label=False %}
        </div>
      </div>
      <div class="required_field">
        {% bootstrap_field_with_tooltip form.has_international_scholarship %}
        <div id="international-scholarship-field">
          {% bootstrap_field form.international_scholarship show_label=False %}
        </div>
      </div>
      <div class="required_field">
        {% bootstrap_field_with_tooltip form.has_erasmus_mundus_scholarship %}
        <div id="erasmus-scholarship-field">
          {% bootstrap_field form.erasmus_mundus_scholarship show_label=False %}
        </div>
      </div>
    {% endpanel %}
  {% endif %}

  {% if view.is_continuing %}
    <div class="row">
      <div
        class="col-md-12 closed-continuing-fields"
        {% if not form.display_closed_continuing_fields %}style="display: none"{% endif %}
      >
        <p id="closed-continuing-alert" class="alert alert-danger">
          {% blocktranslate trimmed %}
            This course is closed. The candidate can express its interest by ticking the box below or by contacting
            a course administrator.
          {% endblocktranslate %}
        </p>
        {% bootstrap_field form.interested_mark %}
      </div>
    </div>

    <div class="row">
      <div class="col-md-12 required_field">
        {% bootstrap_field form.motivations placeholder='' %}
      </div>
    </div>

    <div
      class="row long-continuing-fields"
      {% if not form.display_long_continuing_fields %}style="display: none"{% endif %}
    >
      <div class="col-md-12 required_field">
        {% bootstrap_field form.ways_to_find_out_about_the_course %}
      </div>
    </div>
  {% endif %}

  {% if form.specific_question_answers.field.fields %}
    {% panel _('Specific aspects') %}
      {% bootstrap_field form.specific_question_answers show_label=False error_css_class='' %}
    {% endpanel %}
  {% endif %}

{% endblock %}

{% block script %}
  {{ block.super }}
  <script type="application/javascript">
      $(function () {
          const defaultOptions = {
              duration: 0,
          };

          {% if view.is_general and admission.formation.type|admission_training_type == 'MASTER' %}
              {# Display scholarship search fields when it's required #}
              $('#double-degree-scholarship-field').dependsOn({
                  'input[name="has_double_degree_scholarship"]': {
                      values: ['True'],
                  },
              }, defaultOptions);

              $('#international-scholarship-field').dependsOn({
                  'input[name="has_international_scholarship"]': {
                      values: ['True'],
                  },
              }, defaultOptions);

              $('#erasmus-scholarship-field').dependsOn({
                  'input[name="has_erasmus_mundus_scholarship"]': {
                      values: ['True'],
                  },
              }, defaultOptions);
          {% elif view.is_continuing %}
              const longContinuingFields = $('.long-continuing-fields');
              const closedContinuingFields = $('.closed-continuing-fields');

              {# Reset the training field when the campus or the year changes #}
              $('#id_campus, #id_academic_year').on('change', function(event){
                  $('#id_continuing_education_training').val('').trigger('change');
              });

              {# Toggle the fields depending on the continuing training information #}
              $('#id_continuing_education_training').on('change', function(event){
                  const data = $(this).select2('data')[0];
                  closedContinuingFields.toggle(data?.state === 'CLOSED');
                  longContinuingFields.toggle(data?.registration_required === true);
              });

          {% endif %}

          document.dispatchEvent(new Event('refreshFormInitial'));
      });
  </script>
{% endblock %}
