{% load i18n static enums admission bootstrap3 strings field_data %}

{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2025 Universit√© catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}

{% if experience.authentification_en_cours or experience.statut_authentification != 'NON_CONCERNE' %}
  {% url view.base_namespace|add:':single-past-experience-change-authentication' uuid=view.kwargs.uuid experience_type=experience.type_experience experience_uuid=experience.uuid as current_experience_authentication_url %}
  <form
      id="authentication-form-{{ experience.uuid }}"
      method="post"
      action="{{ current_experience_authentication_url }}"
      hx-post="{{ current_experience_authentication_url }}"
      hx-trigger='change from:input[name="{{ experience.uuid }}-state"]'
      hx-swap="outerHTML"
      hx-target="this"
      class="authentication-form"
      data-default-state-value="{{ authentication_form.state.value }}"
  >
    {% csrf_token %}
    {% bootstrap_form_errors authentication_form %}
    {% bootstrap_field authentication_form.state %}

    {% if authentication_form.state.value == 'AUTHENTIFICATION_DEMANDEE' or authentication_form.state.value == 'ETABLISSEMENT_CONTACTE' %}
      {% if experience_authentication_history_entry %}
        <div class="alert alert-warning">
          <button
              type="button"
              class="btn btn-xs btn-default admission-collapse-button pull-right"
              data-toggle="collapse"
              data-target="#experience-authentication-message-{{ experience.uuid }}"
              aria-expanded="false"
          >
            <i class="fa-solid fa-chevron-up"></i>
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <p id="experience-authentication-message-{{ experience.uuid }}" class="experience-authentication-message">{{ experience_authentication_history_entry|history_entry_message }}</p>
        </div>
      {% endif %}
    {% endif %}

    {% concat 'parcours_anterieur__' experience.uuid|stringformat:'s' '__authentication' as current_authentication_form %}
    {% htmx_comment_form comment_forms|get_item_or_none:current_authentication_form %}

    {% if request.htmx %}
      {# Update the checklist menu item authentication #}
      {% concat 'parcours_anterieur__' experience.uuid|stringformat:'s' as item_name %}
      {# Update the checklist menu tab icons #}
      {% with item_icons=checklist_additional_icons|get_item_or_none:item_name %}
        {% if item_icons %}
          {% for item_icon in item_icons %}
            {% include 'admission/general_education/checklist_menu_item_additional_icon.html' with item_name=item_name item_icon=item_icon %}
          {% endfor %}
        {% endif %}
      {% endwith %}

    {% endif %}
  </form>
{% endif %}
